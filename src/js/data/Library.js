/* src/js/data/Library.js */

// å®šä¹‰ç³»ç»Ÿä¹¦ç±å†…å®¹
const GUIDE_BOOK_I = {
    id: "guide_book_part1",
    title: "ä¼Šè¨å¡æ‰‹è®° Iï¼šå‡ºå‘",
    cover: "assets/images/booksheet/booksheet0.png",
    date: "ç³»ç»ŸæŒ‡å—",
    isReadOnly: true, // ğŸ”’ æ ¸å¿ƒæ ‡è®°ï¼šåªè¯»
    content: `
# åºè¨€

æœ¬æ‰‹è®°æ—¨åœ¨æ¢è®¨ä¸€ä¸ªæ ¸å¿ƒå‘½é¢˜ï¼šåœ¨ç°ä»£æ€§è¯­å¢ƒä¸‹ï¼Œä¸ªä½“å¦‚ä½•é€šè¿‡å™äº‹è¡Œä¸ºé‡æ„è‡ªæˆ‘è®¤åŒã€‚

---

## ç¬¬ä¸€ç« ï¼šå™äº‹è®¤åŒçš„ç†è®ºå›¾è°±

æˆ‘ä»¬éœ€è¦é¦–å…ˆå¤„ç†æœ¬ä½“è®ºå±‚é¢çš„é—®é¢˜ï¼š**â€œæˆ‘â€æ˜¯è°ï¼Ÿ**

åœ¨åˆ†æå“²å­¦å’Œç°è±¡å­¦çš„è§†é‡ä¸­ï¼Œ**ä¿ç½—Â·åˆ©ç§‘ï¼ˆPaul Ricoeurï¼‰**æä¾›äº†ä¸€ä¸ªå…³é”®çš„åŒºåˆ†ï¼šä½œä¸ºâ€œåŒä¸€æ€§â€ï¼ˆIdemï¼‰çš„è‡ªæˆ‘ä¸ä½œä¸ºâ€œè‡ªèº«æ€§â€ï¼ˆIpseï¼‰çš„è‡ªæˆ‘ã€‚å‰è€…æ˜¯ç”Ÿç‰©å­¦æ„ä¹‰ä¸Šçš„æŒä¹…ï¼Œè€Œåè€…æ˜¯æ‰¿è¯ºä¸è´£ä»»çš„ä¸»ä½“ã€‚åˆ©ç§‘è®¤ä¸ºï¼Œè¿æ¥è¿™ä¸¤è€…çš„æ¡¥æ¢æ­£æ˜¯**å™äº‹ï¼ˆNarrativeï¼‰**ã€‚æ—¶é—´åªæœ‰é€šè¿‡å™äº‹è¢«åˆ†èŠ‚ï¼Œæ‰å…·æœ‰äººç±»å­¦çš„æ„ä¹‰ã€‚

æ­¤è§‚ç‚¹åœ¨ç°ä»£å“²å­¦ä¸­å¾—åˆ°äº†å¹¿æ³›çš„å›å“ï¼š
* **éº¦é‡‘æ³°å°”ï¼ˆAlasdair MacIntyreï¼‰** åœ¨ã€Šå¾·è¡Œä¹‹åã€‹ä¸­è®ºè¯ï¼Œäººç±»æœ¬è´¨ä¸Šæ˜¯â€œè®²æ•…äº‹çš„åŠ¨ç‰©â€ï¼Œç”Ÿæ´»å…·æœ‰ä¸€ç§â€œå™äº‹çš„ç»Ÿä¸€æ€§â€ã€‚
* **æŸ¥å°”æ–¯Â·æ³°å‹’ï¼ˆCharles Taylorï¼‰** æŒ‡å‡ºï¼Œè‡ªæˆ‘æ˜¯å­˜åœ¨äºé“å¾·ç©ºé—´ä¸­çš„å¯¼èˆªï¼Œè€Œå™äº‹æä¾›äº†æ–¹ä½çš„åæ ‡ã€‚
* **å®‰ä¸œå°¼Â·å‰ç™»æ–¯ï¼ˆAnthony Giddensï¼‰** åˆ™å¼ºè°ƒï¼Œè‡ªæˆ‘è®¤åŒå¹¶éæ—¢å®šäº‹å®ï¼Œè€Œæ˜¯ä¸ªä½“ä¾æ®ç»å†æŒç»­ç»´æŒçš„ä¸€å¥—è¿è´¯çš„â€œä¼ è®°æ€§å™äº‹â€ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œä¹¦å†™å¹¶éç®€å•çš„è®°å½•ï¼Œè€Œæ˜¯ä¸€ç§**æœ¬ä½“è®ºæ„ä¹‰ä¸Šçš„å»ºæ„è¡Œä¸º**ã€‚

## ç¬¬äºŒç« ï¼šåŸå‹å›å½’â€”â€”ã€Šå¥¥å¾·èµ›ã€‹ç»†è¯»

è¿™ç§â€œå™äº‹å»ºæ„è‡ªæˆ‘â€çš„æœºåˆ¶ï¼Œå¹¶éç°ä»£å‘æ˜ã€‚é€šè¿‡å¯¹è·é©¬å²è¯—ã€Šå¥¥å¾·èµ›ã€‹çš„æ–‡æœ¬ç»†è¯»ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶ä¸­éšå«çš„åŒé‡å™äº‹ç­–ç•¥ã€‚

å¥¥å¾·ä¿®æ–¯çš„å½’ä¹¡ï¼ˆNostosï¼‰å®åˆ™æ˜¯ä¸€åœºèº«ä»½çš„é‡å»ºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ä»–åœ¨ä¸¤ä¸ªä¸åŒåœºåŸŸçš„å™äº‹å±•æ¼”ï¼š

1.  **å…¬å…±åœºåŸŸï¼ˆè´¹åŸƒå…‹æ–¯å®«æ®¿ï¼‰**ï¼šé¢å¯¹é˜¿å°”åŸºè¯ºå¥¥æ–¯ç‹ä¸æ»¡åº§å®¾å®¢ï¼Œå¥¥å¾·ä¿®æ–¯é€šè¿‡å®å¤§çš„å£å¤´æ¼”è¯´ï¼Œå°†æµ·ä¸Šæ¼‚æ³Šçš„ç¦»æ•£ç»éªŒæ•´åˆè¿›â€œæ‹‰ä¼Šå°”ææ–¯ä¹‹å­â€çš„è‹±é›„è°±ç³»ä¸­ã€‚è¿™æ˜¯ **ç¤¾ä¼šèº«ä»½ï¼ˆSocial Identityï¼‰** çš„ç¡®è®¤ã€‚
2.  **ç§å¯†åœºåŸŸï¼ˆç‰§çŒªå¥´çš„èŒ…èˆï¼‰**ï¼šåœ¨é‡è¿”å®«æ®¿å‰ï¼Œä»–å…ˆåœ¨è¾¹ç¼˜çš„èŒ…èˆä¸­é€šè¿‡ä¼ªè£…ä¸ä½è¯­ï¼Œè®²è¿°äº†å…³äºå—éš¾ã€å¿è€ä¸å‘½è¿æ— å¸¸çš„æ•…äº‹ã€‚è¿™æ˜¯ **å†…åœ¨è‡ªæˆ‘ï¼ˆInner Selfï¼‰** çš„æŠšæ…°ä¸æ•´åˆã€‚

è¿™ç§â€œå®«æ®¿-èŒ…èˆâ€çš„äºŒå…ƒç»“æ„ï¼Œæ­ç¤ºäº†å™äº‹åŠŸèƒ½çš„å®Œæ•´æ€§ï¼šå®ƒæ—¢æ˜¯ä¸ªä½“å‘ç¤¾ä¼šçš„æŠ•å°„ï¼Œä¹Ÿæ˜¯ä¸ªä½“å¯¹å†…å¿ƒçš„è§‚ç…§ã€‚

## ç¬¬ä¸‰ç« ï¼šæµåŠ¨çš„ç°ä»£æ€§ä¸é”šç‚¹çš„ä¸§å¤±

ç„¶è€Œï¼Œå°†å¤å…¸ç»éªŒç§»æ¤åˆ°å½“ä»£ç¤¾ä¼šæ—¶ï¼Œæˆ‘ä»¬é­é‡äº†**é½æ ¼è’™ç‰¹Â·é²æ›¼ï¼ˆZygmunt Baumanï¼‰** æ‰€è¨€çš„â€œæµåŠ¨çš„ç°ä»£æ€§â€ï¼ˆLiquid Modernityï¼‰ã€‚

å¥¥å¾·ä¿®æ–¯çš„å¹¸è¿åœ¨äºï¼Œä»–çš„â€œä¼Šè¨å¡â€æ˜¯åœ°ç†ä¸ç¤¾ä¼šç»“æ„ä¸­å›ºå®šçš„é”šç‚¹ã€‚ä½†å½“ä»£äººçš„ç”Ÿå­˜ç°å®å‘ç”Ÿäº†ç»“æ„æ€§æ–­è£‚ï¼š
* **å®å¤§å™äº‹çš„è§£ä½“**ï¼šç¤¾ä¼šä¸å†æä¾›ç»Ÿä¸€çš„æ„ä¹‰å‰§æœ¬ã€‚
* **èº«ä»½çš„æ¶²åŒ–**ï¼šèŒä¸šã€å±…ä½åœ°ã€äººé™…å…³ç³»çš†å¤„äºç¬æ¯ä¸‡å˜ä¹‹ä¸­ã€‚

æˆ‘ä»¬é¢ä¸´ç€ä¸€ç§æ·±åˆ»çš„â€œæœ¬ä½“æ€§ä¸å®‰å…¨æ„Ÿâ€ï¼ˆOntological Insecurityï¼‰ã€‚å¦‚æœåœ¨å¤–éƒ¨ä¸–ç•Œæ‰¾ä¸åˆ°åšå›ºçš„ä¼Šè¨å¡ï¼Œä¸ªä½“ä¾¿å¦‚åŒå¤±å»äº†åæ ‡çš„èˆªèˆ¹ã€‚è¿™æ­£æ˜¯å½“ä»£ç„¦è™‘çš„æ ¹æºï¼š**æˆ‘ä»¬æ‹¥æœ‰è®²è¿°çš„æ¬²æœ›ï¼Œå´å¤±å»äº†è®²è¿°çš„å‚ç…§ç³»ã€‚**

## ç¬¬å››ç« ï¼šä½œä¸ºè§£å†³æ–¹æ¡ˆçš„ä¹¦å†™

é¢å¯¹æµåŠ¨çš„è™šæ— ï¼Œæœ¬ç ”ç©¶é¡¹ç›®ï¼ˆå³è¿™æœ¬ã€Šä¼Šè¨å¡æ‰‹è®°ã€‹ï¼‰æå‡ºäº†ä¸€ç§åŸºäºâ€œå™äº‹ç–—æ³•â€çš„è§£å†³æ–¹æ¡ˆï¼š**é€šè¿‡ç»“æ„åŒ–çš„ä¹¦å†™ï¼Œåœ¨æµåŠ¨ä¸­é‡å»ºé”šç‚¹ã€‚**

å¦‚æœå¤–éƒ¨çš„ä¼Šè¨å¡å·²ä¸å¤å­˜åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¹¦å†™åœ¨å†…éƒ¨å°†å…¶é‡å»ºã€‚æ®æ­¤ï¼Œæˆ‘ä»¬å°†é‡å»ºå·¥ç¨‹åˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ˆå³åç»­çš„åˆ†å†Œå†…å®¹ï¼‰ï¼š

1.  **é”šç‚¹ä¸€ï¼šå™äº‹ä¸è‡ªæˆ‘ï¼ˆèŒ…èˆé˜¶æ®µï¼‰**
    å¯¹åº”ã€Šæ‰‹è®° IIã€‹ã€‚æˆ‘ä»¬å°†é¦–å…ˆåœ¨ç§å¯†é¢†åŸŸå·¥ä½œï¼Œé€šè¿‡å¯¹æ„ŸçŸ¥ã€è®°å¿†ä¸æƒ…ç»ªçš„å¾®è§‚ä¹¦å†™ï¼Œå¯¹æŠ—æ—¶é—´çš„ç¢ç‰‡åŒ–ï¼Œé‡å»ºå†…åœ¨çš„è¿è´¯æ€§ã€‚

2.  **é”šç‚¹äºŒï¼šå™äº‹ä¸ç¤¾ä¼šï¼ˆå®«æ®¿é˜¶æ®µï¼‰**
    å¯¹åº”ã€Šæ‰‹è®° IIIã€‹ã€‚éšåæˆ‘ä»¬å°†è¿›å…¥å…¬å…±è§†é‡ï¼Œå‰–æâ€œæ‹Ÿå‰§è®ºâ€ä¸‹çš„é¢å…·ä¸è§’è‰²ï¼Œé‡æ–°å®¡è§†ä¸ªä½“ä¸ç¤¾ä¼šä¸»å¯¼å™äº‹çš„å…³ç³»ï¼Œåœ¨å–§åš£ä¸­ç¡®ç«‹ä¸»ä½“æ€§ã€‚

è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡å†™ä½œç»ƒä¹ ï¼Œè€Œæ˜¯ä¸€åœº**å­˜åœ¨çš„æŠµæŠ—**ã€‚
è¯·ç¿»å¼€ä¸‹ä¸€é¡µï¼Œæ¡ç´§ä½ çš„ç¬”ã€‚è¿™å°±æ˜¯ä½ çš„æ¡¨ã€‚
`
};

export const Library = {
    books: [],
    
   async init() {
        // 1. è¯»å–å­˜æ¡£
        const saved = await window.ithacaSystem.loadData('library_data.json');
        if (saved) {
            this.books = JSON.parse(saved);
        } else {
            this.books = [];
        }

        // --- ğŸ§¹ ç°æœ‰é€»è¾‘ï¼šæ¸…ç†æ—§çš„ç³»ç»Ÿä¹¦ ---
        this.books = this.books.filter(b => {
            const isOldSystemBook = (b.title.includes("ä¼Šè¨å¡æ‰‹è®°") && b.id !== GUIDE_BOOK_I.id && !b.isMystery);
            return !isOldSystemBook;
        });

        // --- ğŸ› ï¸ ç°æœ‰é€»è¾‘ï¼šæ³¨å…¥/æ›´æ–°ã€Šä¼Šè¨å¡æ‰‹è®° Iã€‹ ---
        const guideIndex = this.books.findIndex(b => b.id === GUIDE_BOOK_I.id);
        if (guideIndex === -1) {
            this.books.unshift(GUIDE_BOOK_I);
        } else {
            this.books[guideIndex] = { 
                ...this.books[guideIndex], 
                content: GUIDE_BOOK_I.content,
                isReadOnly: true,
                title: GUIDE_BOOK_I.title
            };
        }

        // ============================================================
        // âœ¨ æ–°å¢ä¿®å¤é€»è¾‘ï¼šå¼ºåˆ¶æ›´æ–°ã€Šç³–æ°´è èçš„æ—¥è®°ã€‹çš„å°é¢
        // ============================================================
        const targetBookId = "book_pineapple_diary_complete";
        const pineappleBook = this.books.find(b => b.id === targetBookId);
        
        if (pineappleBook) {
            // å¼ºåˆ¶è¦†ç›–ä¸ºæ–°çš„ç»¿è‰²å°é¢ (booksheet1)
            pineappleBook.cover = "assets/images/booksheet/booksheet1.png"; 
            
            // é¡ºæ‰‹å†æ¬¡ç¡®ä¿å®ƒæ˜¯åªè¯»çš„
            pineappleBook.isReadOnly = true; 
            
            console.log("å·²ä¿®å¤ã€Šç³–æ°´è èçš„æ—¥è®°ã€‹å°é¢ä¸å±æ€§");
        }

        // 3. ä¿å­˜æ›´æ”¹åˆ°ç¡¬ç›˜
        this.save(); 
    },

    // å¢
    addBook(book) {
        this.books.push(book);
        this.save();
    },

    // ç‰¹æ®Šå¢åŠ é€»è¾‘
    addMysteryBook(data) {
        const mysteryBook = {
            id: "mystery_book_01", // è¿™é‡Œå¦‚æœä»¥åæœ‰å¤šæœ¬ç¥ç§˜ä¹¦ï¼Œå»ºè®®ç”¨ uuid æˆ–ä¼ å…¥ ID
            title: data.title,
            author: data.author,
            content: data.content,
            cover: data.cover,
            isMystery: true,
            isCollected: true
        };
        
        if (!this.books.find(b => b.id === mysteryBook.id)) {
            this.books.unshift(mysteryBook);
            this.save();
        }
    },

    // æ”¹ (åˆå¹¶åçš„ç‰ˆæœ¬)
    updateBook(id, title, content) {
        const book = this.books.find(b => b.id === id);
        if (book) {
            // ğŸ”’ ä¿æŠ¤é€»è¾‘
            if (book.isReadOnly) {
                console.warn("è¯•å›¾ä¿®æ”¹åªè¯»ä¹¦ç±ï¼Œæ“ä½œè¢«æ‹¦æˆª");
                return false; // è¿”å› false è¡¨ç¤ºå¤±è´¥
            }
            book.title = title;
            book.content = content;
            this.save();
            return true; // è¿”å› true è¡¨ç¤ºæˆåŠŸ
        }
        return false;
    },

    // åˆ  (åˆå¹¶åçš„ç‰ˆæœ¬ï¼Œå»æ‰äº† deleteBookï¼Œç»Ÿä¸€ç”¨ removeBook)
    removeBook(id) {
        const book = this.books.find(b => b.id === id);
        
        // ğŸ”’ ä¿æŠ¤é€»è¾‘
        if (book && book.isReadOnly) {
            console.warn(`ä¹¦ç± ${book.title} æ˜¯ç³»ç»Ÿä¹¦ç±ï¼Œæ— æ³•é”€æ¯ã€‚`);
            return false; 
        }

        const initialLength = this.books.length;
        this.books = this.books.filter(b => b.id !== id);
        
        if (this.books.length !== initialLength) {
            this.save();
            return true;
        }
        return false;
    },

    // æŸ¥
    getAll() {
        return this.books;
    },

    // âœ¨ æ–°å¢ï¼šé‡ç½®å›¾ä¹¦é¦†ï¼ˆæ¸…ç©ºæ‰€æœ‰ä¹¦ç±ï¼Œä½†ä¿ç•™ç³»ç»ŸæŒ‡å—ï¼‰
    reset() {
        // ä¿®å¤ï¼šä¸ç›´æ¥æ¸…ç©ºä¸º []ï¼Œè€Œæ˜¯è¿‡æ»¤ä¿ç•™åªè¯»ä¹¦ç±ï¼ˆå¦‚ç³»ç»ŸæŒ‡å—ã€å‰§æƒ…é“å…·ä¹¦ï¼‰
        this.books = this.books.filter(b => b.isReadOnly);
        
        // å…œåº•ï¼šå¦‚æœè¿‡æ»¤åå‘ç°æŒ‡å—ä¸åœ¨äº† (æå°æ¦‚ç‡)ï¼Œå¼ºåˆ¶åŠ å›æ¥
        const hasGuide = this.books.some(b => b.id === GUIDE_BOOK_I.id);
        if (!hasGuide) {
             this.books.unshift(GUIDE_BOOK_I);
        }

        // 3. ä¿å­˜
        this.save();
        console.log("ğŸ“š å›¾ä¹¦é¦†å·²é‡ç½® (ä¿ç•™äº†ç³»ç»Ÿä¹¦ç±)");
    },

    // å­˜
    save() {
        window.ithacaSystem.saveData('library_data.json', JSON.stringify(this.books));
    }
};